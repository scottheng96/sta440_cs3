---
title: "predictions"
author: "Scott Heng"
date: "10/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(R2jags)
```

```{r}
polls <- read.csv(file='data/presidential_poll_averages_2020.csv') %>% mutate(days_to_election = as.Date(as.character("2020/11/03"), format="%Y/%m/%d")-
                  as.Date(as.character(modeldate), format="%m/%d/%Y"))
### EXERCISE: filter polls to only polls 100 days or fewer before the election and the following states: US,WI,OH,PA,NC,FL,VA
polls_trump <- polls %>%
  filter(candidate_name=="Donald Trump")

polls_biden <- polls %>%
  filter(candidate_name=="Joseph R. Biden Jr.")
```

```{r}
elec_votes <- c(3,10,5,12,13,3,6,38,11,3,9,4,
                20,7,7,18,3,15,29,5,14,4,6,5,
                0,0,0,3,10,6,10,16,11,10,4,0,
                0,8,8,6,6,11,20,4,4,16,29,0,3,
                7,9,55,6,11,3,9)
```

```{r data_list,eval=TRUE}
states <- polls_trump$state %>% unique
y <- polls_trump$pct_estimate
r <- match(polls_trump$state,states)
t <- polls_trump$days_to_election + 1 #WHY PLUS ONE?
N_polls <- y %>% length
N_states <- states %>% length
N_days <- t %>% max
jags_data_trump <- list(y=y,t=t,r=r,
                  N_polls=N_polls,N_states=N_states,N_days=N_days)

states <- polls_biden$state %>% unique
y <- polls_biden$pct_estimate
r <- match(polls_biden$state,states)
t <- polls_biden$days_to_election + 1 #WHY PLUS ONE?
N_polls <- y %>% length
N_states <- states %>% length
N_days <- t %>% max
jags_data_biden <- list(y=y,t=t,r=r,
                  N_polls=N_polls,N_states=N_states,N_days=N_days)
```

```{r}
model <- function(){
  for(k in 1:N_polls){
    y[k] ~ dnorm(p[k],1/sigma2_y[r[k]]) #note no longer binomial
    p[k] = beta[r[k],t[k]] 
  }
  for(j in 2:N_days){
    for(i in 1:N_states){
      beta[i,j] ~ dnorm(beta[i,j-1],pow(sigma2_beta[i],-1))
    }
  }
  
  #EXERCISE: add hierarhciacl prior for sigma2_beta and sigma2_y, i.e. sigma2_beta[j] all come from a common distribution 
  for(j in 1:N_states){
      sigma2_y[j] = 1/sigma2_y_inv[j]
      sigma2_y_inv[j] ~ dgamma(nu_y,nu_y*tau_y) 
      
      sigma2_beta[j] = 1/sigma2_beta_inv[j]
      sigma2_beta_inv[j] ~ dgamma(nu_beta,nu_beta*tau_beta) 
      
      beta[j,1] ~ dnorm(mu0,pow(sigma2_0,-1))
  }
  nu_y ~ dunif(0,100)
  tau_y ~ dunif(0,100)
  
  nu_beta ~ dunif(0,100)
  tau_beta ~ dunif(0,100)
  
  mu0 ~ dnorm(50,pow(7.5,-2))
  sigma2_0 = 1/sigma2_0_inv
  sigma2_0_inv ~ dgamma(.5,.5)
}
```

```{r run_model,eval=TRUE}
#be sure to add your added parameters to parameters.to.save
jags_sims_trump <- jags(data = jags_data_trump,
                  model.file = model,
                  parameters.to.save = c("beta","sigma2_beta","p","sigma2_y"),
                  n.iter = 1000)

jags_sims_biden <- jags(data = jags_data_biden,
                  model.file = model,
                  parameters.to.save = c("beta","sigma2_beta","p","sigma2_y"),
                  n.iter = 1000)
```

```{r}
Calc1 <- function(myDat) # myDat is matrix with 3 cols of n, mean, and SD
{
  m = nrow(myDat)  # number of groups
  tn = 0
  tx = 0
  txx = 0
  for(i in 1:m)
  {
    n = myDat[i,1]
    mean = myDat[i,2]
    sd = myDat[i,3]
    x = n * mean
    xx = sd^2*(n - 1) + x^2 / n 
    out<-cat("grp",i," n=",n," mean=",mean," SD=", sd, " Ex=", x, " Exx=",xx, "\n")
    tn = tn + n
    tx = tx + x
    txx = txx + xx
  }
  tmean = tx / tn
  tsd = sqrt((txx - tx^2/tn) / (tn - 1))
  out <- cat("Combined","n=",tn," mean=",tmean," SD=", tsd, " Ex=", tx, " Exx=",txx,"\n")
  c(tn,tmean,tsd)
}
```


```{r}
trump_df <- data.frame(jags_sims_trump$BUGSoutput$summary)[1:56,] %>% select(n.eff,mean,sd)

binary_pref_trump <- ifelse(trump_df$mean >50, 1,0)
trump_stats <- Calc1(data.matrix(trump_df))

biden_df <- data.frame(jags_sims_biden$BUGSoutput$summary)[1:56,] %>% select(n.eff,mean,sd)

binary_pref_biden <- ifelse(biden_df$mean >50, 1,0)
biden_stats <- Calc1(data.matrix(biden_df))
```

```{r}
conf_int <- function(mean,sd,n) {
  error <- qnorm(0.975)*sd/sqrt(n)
  return(c(mean-error,mean+error))
}
#trump predictions
trump_stats[2]
conf_int(trump_stats[2],trump_stats[3],trump_stats[1])

#biden predictions
biden_stats[2]
conf_int(biden_stats[2], biden_stats[3],biden_stats[1])

```


<!-- 2016 stuff -->
```{r}
polls <- read_csv("data/2016_Economist_Polls.csv") %>% 
  filter(population %in% c("Likely Voters","Registered Voters"),question.iteration == 1) %>% #remove duplicate questions
  mutate(days_to_election = ifelse(end.date == "11/7/16", 1, ifelse(end.date == "11/6/16",2, ifelse(end.date == "11/5/16",3,101))),
         state = ifelse(state == "--","US",state),
         y = clinton/(clinton + trump)*100)

polls <- polls %>%
  filter(days_to_election <= 100)

states <- polls$state %>% unique
y <- polls$y
r <- match(polls$state,states)
t <- polls$days_to_election + 1 #WHY PLUS ONE?
N_polls <- y %>% length
N_states <- states %>% length
N_days <- t %>% max
jags_data <- list(y=y,t=t,r=r,
                  N_polls=N_polls,N_states=N_states,N_days=N_days)

model <- function(){
  for(k in 1:N_polls){
    y[k] ~ dnorm(p[k],1/sigma2_y[r[k]]) #note no longer binomial
    p[k] = beta[r[k],t[k]] 
  }
  for(j in 2:N_days){
    for(i in 1:N_states){
      beta[i,j] ~ dnorm(beta[i,j-1],pow(sigma2_beta[i],-1))
    }
  }
  
  #EXERCISE: add hierarhciacl prior for sigma2_beta and sigma2_y, i.e. sigma2_beta[j] all come from a common distribution 
  for(j in 1:N_states){
      sigma2_y[j] = 1/sigma2_y_inv[j]
      sigma2_y_inv[j] ~ dgamma(nu_y,nu_y*tau_y) 
      
      sigma2_beta[j] = 1/sigma2_beta_inv[j]
      sigma2_beta_inv[j] ~ dgamma(nu_beta,nu_beta*tau_beta) 
      
      beta[j,1] ~ dnorm(mu0,pow(sigma2_0,-1))
  }
  nu_y ~ dunif(0,100)
  tau_y ~ dunif(0,100)
  
  nu_beta ~ dunif(0,100)
  tau_beta ~ dunif(0,100)
  
  mu0 ~ dnorm(50,pow(7.5,-2))
  sigma2_0 = 1/sigma2_0_inv
  sigma2_0_inv ~ dgamma(.5,.5)
}

jags_sims <- jags(data = jags_data,model.file = model,parameters.to.save = c("beta","sigma2_beta",
                                                                             "p","sigma2_y"),
                  n.iter = 1500)
```

```{r}
clinton_df <- data.frame(jags_sims$BUGSoutput$summary)[1:56,] %>% select(n.eff,mean,sd)

binary_pref_clinton <- ifelse(clinton_df$mean >50, 1,0)
jags_sims$BUGSoutput$sims.array[1:1500]
```